name: ğŸ“¦ Package Coze Studio Offline Bundle

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*.*.*'

jobs:
  package:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ğŸ” Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive  # å¦‚æœæœ‰å­æ¨¡å—
          fetch-depth: 1

      - name: ğŸ³ Set up Docker
        uses: docker/setup-buildx-action@v3

      # ==============================
      # âœ… å…³é”®ï¼šåœ¨é¡¹ç›®æ ¹ç›®å½•æ„å»ºè‡ªç ”æœåŠ¡
      # ==============================
      - name: ğŸ§± Build coze-server from root
        run: |
          docker build \
            -t cozedev/coze-studio-server:latest \
            -f backend/Dockerfile \
            .

      - name: ğŸ§± Build coze-web from root
        run: |
          docker build \
            -t cozedev/coze-studio-web:latest \
            -f frontend/Dockerfile \
            .

      # ==============================
      # âœ… éªŒè¯é•œåƒæ˜¯å¦çœŸçš„å­˜åœ¨
      # ==============================
      - name: ğŸ” Verify custom images exist
        run: |
          docker images | grep cozedev
          if ! docker images cozedev/coze-studio-server:latest --format "{{.ID}}" | grep -q .; then
            echo "âŒ coze-server image missing!"
            exit 1
          fi
          if ! docker images cozedev/coze-studio-web:latest --format "{{.ID}}" | grep -q .; then
            echo "âŒ coze-web image missing!"
            exit 1
          fi

      # ==============================
      # âœ… æ‹‰å–æ‰€æœ‰å…¬å…±åŸºç¡€é•œåƒï¼ˆç¡®ä¿å®Œæ•´ç¦»çº¿ï¼‰
      # ==============================
      - name: ğŸ“¥ Pull all public base images
        run: |
          cd docker
          IMAGES=$(docker compose config --images | grep -v "cozedev/")
          echo "Pulling public images: $IMAGES"
          for img in $IMAGES; do
            docker pull "$img"
          done

      # ==============================
      # âœ… å¯¼å‡ºå®Œæ•´é•œåƒåŒ…
      # ==============================
      - name: ğŸ’¾ Save all images to tar
        run: |
          cd docker
          IMAGES=$(docker compose config --images)
          echo "Saving images:"
          echo "$IMAGES"
          docker save $IMAGES -o coze-studio-full.tar

      - name: ğŸ—œï¸ Compress
        run: gzip -9 docker/coze-studio-full.tar

      - name: ğŸ“¤ Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: coze-offline-bundle
          path: docker/coze-studio-full.tar.gz
          retention-days: 30

      - name: ğŸš€ Release (if tagged)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: docker/coze-studio-full.tar.gz
