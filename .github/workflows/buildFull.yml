name: ğŸ“¦ Package Coze Studio Offline Docker Bundle

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘ï¼ˆæ¨èï¼‰
  push:
    tags:
      - 'v*.*.*'      # æ‰“ tag æ—¶è‡ªåŠ¨å‘å¸ƒåˆ° Releases

jobs:
  package-offline-bundle:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # ç”¨äºå‘å¸ƒ Release

    steps:
      - name: ğŸ” Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ“ Navigate to docker directory
        run: cd docker && pwd

      - name: ğŸ› ï¸ Prepare .env file
        run: |
          cd docker
          cp .env.example .env
          # å¯é€‰ï¼šå…³é—­é¥æµ‹ã€è®¾é»˜è®¤å€¼ç­‰
          sed -i 's/TELEMETRY_ENABLED=.*/TELEMETRY_ENABLED=false/' .env || true

      - name: ğŸ§± Build all services (including coze-server & coze-web)
        run: |
          cd docker
          # å¼ºåˆ¶ä»æºç æ„å»ºï¼Œå³ä½¿ compose æ–‡ä»¶ä¸­ image å·²å®šä¹‰
          docker compose build --no-cache --pull

      - name: ğŸ“‹ List built images
        run: |
          cd docker
          echo "=== Built images ==="
          docker compose config --images

      - name: ğŸ’¾ Save all images to tarball
        run: |
          cd docker
          IMAGES=$(docker compose config --images)
          echo "Saving images: $IMAGES"
          docker save $IMAGES -o coze-studio-full.tar

      - name: ğŸ—œï¸ Compress tarball (reduce size)
        run: |
          cd docker
          gzip -9 coze-studio-full.tar

      - name: ğŸ“¤ Upload as GitHub Artifact
        uses: actions/upload-artifact@v4
        with:
          name: coze-studio-offline-bundle
          path: docker/coze-studio-full.tar.gz
          retention-days: 30

      - name: ğŸš€ Publish to GitHub Releases (if tagged)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: docker/coze-studio-full.tar.gz
          token: ${{ secrets.GITHUB_TOKEN }}
          draft: false
          prerelease: false
